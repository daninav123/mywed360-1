        setLoading(false);
        return;
      }
      if (!import.meta.env.VITE_OPENAI_API_KEY) {
        // Fallback: generar una web básica con los datos del perfil sin IA
        const safe = (v) => (v || '').toString();
        const b = safe(weddingInfo.bride);
        const g = safe(weddingInfo.groom);
        const names = [b, g].filter(Boolean).join(' y ');
        const palette = safe(weddingInfo.colorScheme) || 'Blanco y dorado';
        const styleTitle = safe(weddingInfo.weddingStyle) || 'Clásico';
        const ceremony = [safe(weddingInfo.ceremonyLocation), safe(weddingInfo.ceremonyTime)]
          .filter(Boolean)
          .join(' · ');
        const reception = [safe(weddingInfo.receptionVenue), safe(weddingInfo.receptionTime)]
          .filter(Boolean)
          .join(' · ');
        const date = safe(weddingInfo.date);
        const extra = safe(weddingInfo.additionalInfo);
        const contact = [safe(weddingInfo.contactEmail), safe(weddingInfo.contactPhone)]
          .filter(Boolean)
          .join(' · ');
        const demo = `<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${names ? `${names} · Web de boda` : 'Nuestra boda'}</title>
    <style>
      :root{ --primary:#b5812d; --text:#222; --muted:#666 }
      *{box-sizing:border-box}
      body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; color:var(--text); background:#fff}
      header{padding:48px 16px; text-align:center; border-bottom:1px solid #eee}
      h1{margin:0; font-size: clamp(28px, 5vw, 44px)}
      h2{margin:0 0 8px; font-size: 20px}
      .subtitle{color:var(--muted); margin-top:8px}
      .container{max-width:920px; margin:0 auto; padding:24px 16px}
      .grid{display:grid; grid-template-columns: 1fr; gap:16px}
      @media(min-width:768px){ .grid{ grid-template-columns: 1fr 1fr } }
      .card{border:1px solid #eee; border-radius:12px; padding:16px}
      .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#faf5ee; color:#8a5b20; font-size:12px}
      .highlight{color: var(--primary)}
      footer{border-top:1px solid #eee; text-align:center; padding:24px; color:var(--muted); font-size:14px}
    </style>
  </head>
  <body>
    <header>
      <div class="pill">Estilo: ${styleTitle} · Paleta: ${palette}</div>
      <h1>${names || 'Nuestra boda'}</h1>
      ${date ? `<div class="subtitle">${date}</div>` : ''}
    </header>
    <main class="container">
      <section class="grid">
        <div class="card">
          <h2>La ceremonia</h2>
          <div>${ceremony || 'Pronto más detalles'}</div>
          ${weddingInfo.ceremonyAddress ? `<div class="subtitle">${safe(weddingInfo.ceremonyAddress)}</div>` : ''}
        </div>
        <div class="card">
          <h2>La recepción</h2>
          <div>${reception || 'Pronto más detalles'}</div>
          ${weddingInfo.receptionAddress ? `<div class="subtitle">${safe(weddingInfo.receptionAddress)}</div>` : ''}
        </div>
      </section>
      <section class="grid">
        <div class="card">
          <h2>Transporte y alojamiento</h2>
          <div>${safe(weddingInfo.transportation) || 'Pronto más detalles'}</div>
        </div>
        <div class="card">
          <h2>Regalos y notas</h2>
          <div>${extra || '¡Vuestra presencia es el mejor regalo!'}</div>
        </div>
      </section>
      <section class="card" style="margin-top:16px">
        <h2>Contacto</h2>
        <div>${contact || '—'}</div>
      </section>
    </main>
    <footer>
      <span class="highlight">Gracias</span> por acompañarnos en este día.
    </footer>
  </body>
</html>`;
        setHtml(demo);
        return;
      }

      // Extraer datos relevantes del perfil
      const {
        brideInfo = {},
