generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String?
  emailVerified      Boolean             @default(false)
  verificationToken  String?             @unique
  resetToken         String?             @unique
  resetTokenExpiry   DateTime?
  provider           String              @default("email")
  lastLogin          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  role               UserRole            @default(OWNER)
  guests             Guest[]
  planners           Planner[]
  refreshTokens      RefreshToken[]
  suppliers          Supplier[]
  weddings           Wedding[]           @relation("UserWeddings")
  accessPermissions  WeddingAccess[]
  sessions           Session[]
  profile            UserProfile?

  @@index([email])
  @@index([role])
  @@index([verificationToken])
  @@index([resetToken])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model WeddingAccess {
  id          String      @id @default(uuid())
  userId      String
  weddingId   String
  role        WeddingRole @default(VIEWER)
  permissions Json?
  status      String      @default("active")
  invitedBy   String?
  invitedAt   DateTime    @default(now())
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  wedding     Wedding     @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@unique([userId, weddingId])
  @@index([weddingId])
  @@index([userId])
  @@index([role])
  @@map("wedding_access")
}

model Wedding {
  id                 String            @id @default(uuid())
  userId             String
  coupleName         String
  weddingDate        DateTime
  celebrationPlace   String?
  celebrationAddress String?
  banquetPlace       String?
  receptionAddress   String?
  schedule           String?
  numGuests          Int               @default(0)
  weddingStyle       String?
  colorScheme        String?
  rsvpDeadline       DateTime?
  giftAccount        String?
  transportation     String?
  importantInfo      String?
  status             String            @default("active")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  budgetData         Json?
  seatingData        Json?
  weddingInfo        Json?
  ceremonyData       Json?
  supplierGroupsData Json?
  craftWebs          CraftWeb[]
  guests             Guest[]
  access             WeddingAccess[]
  suppliers          WeddingSupplier[]
  tasks              Task[]
  timelineEvents     TimelineEvent[]
  specialMoments     SpecialMoment[]
  transactions       Transaction[]
  user               User              @relation("UserWeddings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([weddingDate])
  @@index([status])
  @@map("weddings")
}

model Guest {
  id                  String   @id @default(uuid())
  weddingId           String
  userId              String?
  name                String
  email               String?
  phone               String?
  confirmed           Boolean  @default(false)
  status              String   @default("pending")
  companions          Int      @default(0)
  dietaryRestrictions String?
  notes               String?
  tableNumber         Int?
  seatNumber          Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User?    @relation(fields: [userId], references: [id])
  wedding             Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([email])
  @@index([status])
  @@map("guests")
}

model Supplier {
  id           String              @id @default(uuid())
  userId       String
  businessName String
  category     String
  description  String?
  email        String
  phone        String?
  website      String?
  address      String?
  city         String?
  country      String?
  instagram    String?
  facebook     String?
  services     Json?
  priceRange   String?
  rating       Float               @default(0)
  reviewCount  Int                 @default(0)
  verified     Boolean             @default(false)
  featured     Boolean             @default(false)
  active       Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  portfolio    SupplierPortfolio[]
  user         User                @relation(fields: [userId], references: [id])
  weddings     WeddingSupplier[]

  @@index([userId])
  @@index([category])
  @@index([city])
  @@index([verified])
  @@index([featured])
  @@map("suppliers")
}

model SupplierPortfolio {
  id          String   @id @default(uuid())
  supplierId  String
  imageUrl    String
  title       String?
  description String?
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@map("supplier_portfolio")
}

model WeddingSupplier {
  id         String   @id @default(uuid())
  weddingId  String
  supplierId String
  status     String   @default("contacted")
  budget     Float?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  wedding    Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@unique([weddingId, supplierId])
  @@index([weddingId])
  @@index([supplierId])
  @@map("wedding_suppliers")
}

model CraftWeb {
  id          String    @id @default(uuid())
  weddingId   String
  userId      String
  slug        String    @unique
  title       String
  published   Boolean   @default(false)
  structure   Json
  theme       Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  wedding     Wedding   @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([slug])
  @@index([published])
  @@map("craft_webs")
}

model RsvpResponse {
  id                  String   @id @default(uuid())
  webId               String
  guestId             String?
  name                String
  email               String
  status              String
  companions          Int      @default(0)
  dietaryRestrictions String?
  notes               String?
  createdAt           DateTime @default(now())

  @@index([webId])
  @@index([email])
  @@map("rsvp_responses")
}

model Planner {
  id           String   @id @default(uuid())
  userId       String
  businessName String
  description  String?
  email        String
  phone        String?
  website      String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("planners")
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  phone     String?
  role      String?
  settings  Json?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

enum UserRole {
  OWNER
  ASSISTANT
  PLANNER
  SUPPLIER
  ADMIN
}

enum WeddingRole {
  OWNER
  PLANNER
  ASSISTANT
  VIEWER
}

model Task {
  id          String    @id @default(uuid())
  weddingId   String
  title       String
  description String?
  category    String    @default("general")
  status      String    @default("pending")
  dueDate     DateTime?
  priority    String?   @default("medium")
  assignedTo  String?
  completed   Boolean   @default(false)
  completedAt DateTime?
  order       Int       @default(0)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  wedding     Wedding   @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([status])
  @@index([dueDate])
  @@index([category])
  @@map("tasks")
}

model TimelineEvent {
  id        String   @id @default(uuid())
  weddingId String
  name      String
  startTime String
  endTime   String
  status    String   @default("on-time")
  order     Int      @default(0)
  moments   Json?
  alerts    Json?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([order])
  @@map("timeline_events")
}

model SpecialMoment {
  id          String   @id @default(uuid())
  weddingId   String
  blockId     String
  title       String
  time        String?
  duration    String?  @default("15")
  songTitle   String?
  artist      String?
  spotifyId   String?
  responsible String?
  status      String   @default("pendiente")
  type        String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  wedding     Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([blockId])
  @@map("special_moments")
}

model Transaction {
  id          String    @id @default(uuid())
  weddingId   String
  category    String
  description String
  amount      Float
  type        String    @default("expense")
  status      String    @default("pending")
  dueDate     DateTime?
  paidDate    DateTime?
  supplierId  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  wedding     Wedding   @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@index([weddingId])
  @@index([category])
  @@index([status])
  @@index([type])
  @@map("transactions")
}
