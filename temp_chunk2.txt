    const sentRef = await db.collection('mails').add({
      from: from,
      to,
      subject,
      body,
      date,
      folder: 'sent',
      read: true,
    });
    try { await db.collection('mails').doc(sentRef.id).update({ id: sentRef.id }); } catch {}

    // Intentar guardar copia en subcoleccion del remitente
    if (!recordOnly) {
    try {
      const uid = req.user?.uid;
      if (uid) {
        await db.collection('users').doc(uid).collection('mails').doc(sentRef.id).set({
          id: sentRef.id,
          from,
          to,
          subject,
          body,
          date,
          folder: 'sent',
          read: true,
          via: 'backend'
        });
      }
    } catch (e) {
      console.warn('No se pudo registrar el enviado en subcoleccion del usuario:', e?.message || e);
    }

    // Registro en carpeta 'inbox' para el destinatario (sin leer)
    const inboxRef = await db.collection('mails').add({
      from: from,
      to,
      subject,
      body,
      date,
      folder: 'inbox',
      read: false,
    });
    try { await db.collection('mails').doc(inboxRef.id).update({ id: inboxRef.id }); } catch {}

    // Intentar guardar copia en subcoleccion del destinatario si pertenece a un usuario
    try {
      let uid = null;
      const byAlias = await db.collection('users').where('myWed360Email', '==', to).limit(1).get();
      if (!byAlias.empty) {
        uid = byAlias.docs[0].id;
      } else {
        const byLogin = await db.collection('users').where('email', '==', to).limit(1).get();
        if (!byLogin.empty) uid = byLogin.docs[0].id;
      }
      if (uid) {
        await db.collection('users').doc(uid).collection('mails').doc(inboxRef.id).set({
          id: inboxRef.id,
          from,
          to,
          subject,
          body,
          date,
          folder: 'inbox',
          read: false,
          via: 'backend'
        });
      }
    } catch (e) {
      console.warn('No se pudo registrar el inbox en subcoleccion del destinatario:', e?.message || e);
    }

    res.status(201).json({ id: sentRef.id, to, subject, body, date, folder: 'sent', read: true, from: from });
  } catch (err) {
    console.error('Error en POST /api/mail:', err);
    res.status(503).json({ 
      success: false,
      message: 'Fallo enviando correo',
      error: err?.message || String(err),
      hint: 'Si es envío real, verifica MAILGUN_API_KEY, MAILGUN_DOMAIN (p.ej. mg.mywed360.com) y MAILGUN_EU_REGION=true',
    });
  }
});

// PATCH /api/mail/:id/read
router.patch('/:id/read', requireMailAccess, async (req, res) => {
  try {
    const { id } = req.params;
    const docRef = db.collection('mails').doc(id);
    const doc = await docRef.get();
    if (!doc.exists) return res.status(404).json({ error: 'Not found' });
    const data = doc.data();
    await docRef.update({ read: true });

    // Propagar cambio a subcolección del usuario propietario (inbox -> to, sent -> from)
    try {
      const targetEmail = (data.folder === 'sent') ? data.from : data.to;
      if (targetEmail) {
        let uid = null;
        const byAlias = await db.collection('users').where('myWed360Email', '==', targetEmail).limit(1).get();
        if (!byAlias.empty) {
          uid = byAlias.docs[0].id;
        } else {
          const byLogin = await db.collection('users').where('email', '==', targetEmail).limit(1).get();
          if (!byLogin.empty) uid = byLogin.docs[0].id;
        }
        if (uid) {
          await db.collection('users').doc(uid).collection('mails').doc(id).set({ read: true }, { merge: true });
        }
      }
    } catch (e) {
      console.warn('No se pudo propagar read a subcolección de usuario:', e?.message || e);
    }

    res.json({ id, ...data, read: true });
  } catch (err) {
    console.error('Error en PATCH /api/mail/:id/read:', err);
    res.status(503).json({ success: false, message: 'Fallo actualizando mail', error: err?.message || String(err) });
  }
});

// Compatibilidad: también aceptar POST para marcar como leído
router.post('/:id/read', requireMailAccess, async (req, res) => {
  try {
    const { id } = req.params;
    const docRef = db.collection('mails').doc(id);
    const doc = await docRef.get();
    if (!doc.exists) return res.status(404).json({ error: 'Not found' });
    const data = doc.data();
    await docRef.update({ read: true });

    // Propagar a subcolección
    try {
      const targetEmail = (data.folder === 'sent') ? data.from : data.to;
      if (targetEmail) {
        let uid = null;
        const byAlias = await db.collection('users').where('myWed360Email', '==', targetEmail).limit(1).get();
        if (!byAlias.empty) {
          uid = byAlias.docs[0].id;
        } else {
          const byLogin = await db.collection('users').where('email', '==', targetEmail).limit(1).get();
          if (!byLogin.empty) uid = byLogin.docs[0].id;
        }
        if (uid) {
          await db.collection('users').doc(uid).collection('mails').doc(id).set({ read: true }, { merge: true });
        }
      }
    } catch (e) {
      console.warn('No se pudo propagar read (POST) a subcolección de usuario:', e?.message || e);
    }

    res.json({ id, ...data, read: true });
  } catch (err) {
    console.error('Error en POST /api/mail/:id/read:', err);
    res.status(503).json({ success: false, message: 'Fallo actualizando mail', error: err?.message || String(err) });
  }
});

// DELETE /api/mail/:id
router.delete('/:id', requireMailAccess, async (req, res) => {
  try {
    const { id } = req.params;
    const docRef = db.collection('mails').doc(id);
    const snap = await docRef.get();
    const data = snap.exists ? snap.data() : null;
    await docRef.delete();

    // Intentar eliminar la copia en subcolección de usuario si existe
    try {
      if (data) {
        const targetEmail = (data.folder === 'sent') ? data.from : data.to;
        if (targetEmail) {
          let uid = null;
          const byAlias = await db.collection('users').where('myWed360Email', '==', targetEmail).limit(1).get();
          if (!byAlias.empty) {
            uid = byAlias.docs[0].id;
          } else {
            const byLogin = await db.collection('users').where('email', '==', targetEmail).limit(1).get();
            if (!byLogin.empty) uid = byLogin.docs[0].id;
          }
          if (uid) {
            await db.collection('users').doc(uid).collection('mails').doc(id).delete();
          }
        }
      }
    } catch (e) {
      console.warn('No se pudo eliminar de subcolección de usuario:', e?.message || e);
    }
    res.status(204).end();
  } catch (err) {
    console.error('Error en DELETE /api/mail/:id:', err);
    res.status(503).json({ success: false, message: 'Fallo eliminando mail', error: err?.message || String(err) });
  }
});

/**
 * Endpoint para enviar un correo de prueba usando dirección personalizada
 * @route POST /api/mail/test-personal-email
 */
router.post('/test-personal-email', requireMailAccess, async (req, res) => {
  try {
